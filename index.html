import React, { useState, useRef, useEffect } from 'react';

const PianoScaleGame = () => {
  const [gameState, setGameState] = useState('start'); // start, playing, levelComplete, gameOver
  const [currentLevel, setCurrentLevel] = useState(0);
  const [score, setScore] = useState(0);
  const [lives, setLives] = useState(3);
  const [currentStep, setCurrentStep] = useState(0);
  const [taps, setTaps] = useState([]);
  const [feedback, setFeedback] = useState(null);
  const [showLabels, setShowLabels] = useState(true);
  const audioContextRef = useRef(null);

  useEffect(() => {
    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
  }, []);

  const notes = [
    { note: 'C', freq: 261.63, isBlack: false },
    { note: 'C#', freq: 277.18, isBlack: true },
    { note: 'D', freq: 293.66, isBlack: false },
    { note: 'D#', freq: 311.13, isBlack: true },
    { note: 'E', freq: 329.63, isBlack: false },
    { note: 'F', freq: 349.23, isBlack: false },
    { note: 'F#', freq: 369.99, isBlack: true },
    { note: 'G', freq: 392.00, isBlack: false },
    { note: 'G#', freq: 415.30, isBlack: true },
    { note: 'A', freq: 440.00, isBlack: false },
    { note: 'A#', freq: 466.16, isBlack: true },
    { note: 'B', freq: 493.88, isBlack: false },
    { note: 'C', freq: 523.25, isBlack: false, highC: true }
  ];

  const scales = [
    { name: 'C Major', sequence: ['C', 'D', 'E', 'F', 'G', 'A', 'B', 'C'] },
    { name: 'G Major', sequence: ['G', 'A', 'B', 'C', 'D', 'E', 'F#', 'G'] },
    { name: 'F Major', sequence: ['F', 'G', 'A', 'A#', 'C', 'D', 'E', 'F'] },
    { name: 'D Major', sequence: ['D', 'E', 'F#', 'G', 'A', 'B', 'C#', 'D'] }
  ];

  const currentScale = scales[currentLevel];
  const expectedNote = currentScale?.sequence[currentStep];

  const playNote = (frequency, duration = 1) => {
    const ctx = audioContextRef.current;
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);

    oscillator.frequency.value = frequency;
    oscillator.type = 'sine';

    gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);

    oscillator.start(ctx.currentTime);
    oscillator.stop(ctx.currentTime + duration);
  };

  const playSuccessSound = () => {
    const ctx = audioContextRef.current;
    [523.25, 659.25, 783.99].forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = freq;
      osc.type = 'sine';
      gain.gain.setValueAtTime(0.2, ctx.currentTime + i * 0.1);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.1 + 0.3);
      osc.start(ctx.currentTime + i * 0.1);
      osc.stop(ctx.currentTime + i * 0.1 + 0.3);
    });
  };

  const handleKeyPress = (note, freq, index) => {
    if (gameState !== 'playing') return;

    playNote(freq, 0.5);

    // Handle high C separately
    const actualNote = note.highC ? 'C' : note.note;
    const isCorrect = actualNote === expectedNote;

    if (isCorrect) {
      setTaps(prev => [...prev, { note: actualNote, index, id: Date.now(), correct: true }]);
      setScore(prev => prev + 10);

      if (currentStep === currentScale.sequence.length - 1) {
        // Scale complete!
        setScore(prev => prev + 50);
        playSuccessSound();
        setTimeout(() => {
          setGameState('levelComplete');
        }, 800);
      } else {
        setCurrentStep(prev => prev + 1);
      }
    } else {
      setTaps(prev => [...prev, { note: actualNote, index, id: Date.now(), correct: false }]);
      setFeedback({ type: 'wrong', note: actualNote });
      setLives(prev => prev - 1);
      
      setTimeout(() => setFeedback(null), 500);

      if (lives - 1 <= 0) {
        setTimeout(() => {
          setGameState('gameOver');
        }, 800);
      }
    }
  };

  const startGame = () => {
    setGameState('playing');
    setScore(0);
    setLives(3);
    setCurrentLevel(0);
    setCurrentStep(0);
    setTaps([]);
    setFeedback(null);
  };

  const nextLevel = () => {
    if (currentLevel < scales.length - 1) {
      setCurrentLevel(prev => prev + 1);
      setCurrentStep(0);
      setTaps([]);
      setLives(3);
      setGameState('playing');
    } else {
      setGameState('gameOver');
    }
  };

  const whiteNotes = notes.filter(n => !n.isBlack);
  const blackNotes = notes.filter(n => n.isBlack);

  if (gameState === 'start') {
    return (
      <div className="min-h-screen bg-gradient-to-b from-purple-100 to-blue-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md text-center">
          <h1 className="text-4xl font-bold text-purple-900 mb-4">üéπ Piano Scale Master</h1>
          <p className="text-gray-700 mb-6">Learn piano scales by playing them in the correct sequence!</p>
          <div className="bg-purple-50 rounded-lg p-4 mb-6 text-left">
            <h3 className="font-bold text-purple-900 mb-2">How to Play:</h3>
            <ul className="text-sm text-gray-700 space-y-1">
              <li>‚Ä¢ Tap the piano keys in the correct order</li>
              <li>‚Ä¢ Follow the highlighted keys</li>
              <li>‚Ä¢ Complete the scale to earn points</li>
              <li>‚Ä¢ You have 3 lives per scale</li>
            </ul>
          </div>
          <button
            onClick={startGame}
            className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg"
          >
            Start Game
          </button>
        </div>
      </div>
    );
  }

  if (gameState === 'levelComplete') {
    return (
      <div className="min-h-screen bg-gradient-to-b from-green-100 to-blue-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md text-center">
          <h1 className="text-5xl mb-4">üéâ</h1>
          <h2 className="text-3xl font-bold text-green-600 mb-2">Scale Complete!</h2>
          <p className="text-xl text-gray-700 mb-4">You mastered the {currentScale.name} scale!</p>
          <div className="bg-green-50 rounded-lg p-4 mb-6">
            <p className="text-2xl font-bold text-green-700">Score: {score}</p>
            <p className="text-sm text-gray-600">+50 bonus points!</p>
          </div>
          <button
            onClick={nextLevel}
            className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg"
          >
            {currentLevel < scales.length - 1 ? 'Next Scale' : 'Finish Game'}
          </button>
        </div>
      </div>
    );
  }

  if (gameState === 'gameOver') {
    return (
      <div className="min-h-screen bg-gradient-to-b from-red-100 to-orange-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md text-center">
          <h1 className="text-4xl font-bold text-red-600 mb-4">
            {currentLevel >= scales.length - 1 ? 'üèÜ Congratulations!' : 'üòî Game Over'}
          </h1>
          <p className="text-xl text-gray-700 mb-4">
            {currentLevel >= scales.length - 1 
              ? 'You completed all scales!' 
              : 'Keep practicing and try again!'}
          </p>
          <div className="bg-orange-50 rounded-lg p-4 mb-6">
            <p className="text-2xl font-bold text-orange-700">Final Score: {score}</p>
            <p className="text-sm text-gray-600">Scales completed: {currentLevel + (currentLevel >= scales.length - 1 ? 1 : 0)}</p>
          </div>
          <button
            onClick={startGame}
            className="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg"
          >
            Play Again
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-blue-50 to-purple-50 flex flex-col items-center justify-center p-4">
      <div className="max-w-4xl w-full">
        {/* Header */}
        <div className="bg-white rounded-lg shadow-lg p-4 mb-4">
          <div className="flex justify-between items-center mb-3">
            <div>
              <h2 className="text-2xl font-bold text-purple-900">{currentScale.name}</h2>
              <p className="text-sm text-gray-600">Level {currentLevel + 1} of {scales.length}</p>
            </div>
            <div className="text-right">
              <p className="text-2xl font-bold text-purple-700">{score}</p>
              <p className="text-xs text-gray-600">Score</p>
            </div>
          </div>

          {/* Lives */}
          <div className="flex gap-2 mb-3">
            {[...Array(3)].map((_, i) => (
              <div
                key={i}
                className={`w-8 h-8 rounded-full ${
                  i < lives ? 'bg-red-500' : 'bg-gray-300'
                }`}
              >
                {i < lives && <span className="flex items-center justify-center h-full text-white">‚ù§Ô∏è</span>}
              </div>
            ))}
          </div>

          {/* Sequence Display */}
          <div className="flex gap-2 overflow-x-auto mb-3">
            {currentScale.sequence.map((note, idx) => (
              <div
                key={idx}
                className={`flex-shrink-0 px-4 py-2 rounded-lg font-bold ${
                  idx < currentStep
                    ? 'bg-green-500 text-white'
                    : idx === currentStep
                    ? 'bg-yellow-400 text-gray-900 ring-4 ring-yellow-300'
                    : 'bg-gray-200 text-gray-600'
                }`}
              >
                {note}
              </div>
            ))}
          </div>

          {/* Labels Toggle */}
          <div className="flex items-center justify-center gap-3 bg-gray-100 rounded-lg p-2">
            <span className="text-sm font-semibold text-gray-700">Show Key Labels:</span>
            <button
              onClick={() => setShowLabels(!showLabels)}
              className={`relative w-14 h-7 rounded-full transition-colors ${
                showLabels ? 'bg-green-500' : 'bg-gray-400'
              }`}
            >
              <div
                className={`absolute top-1 left-1 w-5 h-5 bg-white rounded-full transition-transform ${
                  showLabels ? 'transform translate-x-7' : ''
                }`}
              />
            </button>
            <span className="text-xs text-gray-600">{showLabels ? 'ON' : 'OFF'}</span>
          </div>
        </div>

        {/* Feedback */}
        {feedback && feedback.type === 'wrong' && (
          <div className="text-center py-2 mb-2 rounded-lg font-bold text-xl bg-red-500 text-white">
            ‚úó Wrong note!
          </div>
        )}

        {/* Piano */}
        <div className="bg-gradient-to-b from-amber-800 to-amber-900 p-6 rounded-lg shadow-2xl">
          <div className="relative bg-white rounded" style={{ height: '300px' }}>
            {/* White keys */}
            <div className="flex h-full">
              {whiteNotes.map((noteObj, idx) => {
                const originalIndex = notes.findIndex(n => n.note === noteObj.note && n.freq === noteObj.freq);
                const keyTaps = taps.filter(t => t.index === originalIndex);
                
                return (
                  <div
                    key={`white-${idx}-${noteObj.freq}`}
                    className="flex-1 border-2 border-gray-800 bg-white hover:bg-gray-100 active:bg-gray-200 cursor-pointer relative transition-colors rounded-b"
                    onTouchStart={(e) => {
                      e.preventDefault();
                      handleKeyPress(noteObj, noteObj.freq, originalIndex);
                    }}
                    onClick={(e) => handleKeyPress(noteObj, noteObj.freq, originalIndex)}
                  >
                    {keyTaps.map(tap => (
                      <div
                        key={tap.id}
                        className={`absolute w-6 h-6 rounded-full opacity-70 pointer-events-none ${
                          tap.correct ? 'bg-green-500' : 'bg-red-500'
                        }`}
                        style={{
                          left: '50%',
                          top: '40%',
                          transform: 'translate(-50%, -50%)'
                        }}
                      />
                    ))}
                    {showLabels && (
                      <span className="absolute bottom-2 left-1/2 transform -translate-x-1/2 text-sm font-semibold text-gray-700">
                        {noteObj.highC ? 'C' : noteObj.note}
                      </span>
                    )}
                  </div>
                );
              })}
            </div>

            {/* Black keys */}
            <div className="absolute top-0 left-0 w-full h-3/5 pointer-events-none">
              <div className="flex h-full relative">
                {whiteNotes.slice(0, -1).map((_, idx) => {
                  const whiteKeyWidth = 100 / whiteNotes.length;
                  const blackKeyIndex = [0, 1, 3, 4, 5][idx % 7];
                  
                  if (blackKeyIndex !== undefined && idx < 6) {
                    const blackNote = blackNotes[Math.floor(idx / 7) * 5 + ([0, 1, 3, 4, 5].indexOf(idx % 7))];
                    if (blackNote) {
                      const originalIndex = notes.findIndex(n => n.note === blackNote.note && n.freq === blackNote.freq);
                      const keyTaps = taps.filter(t => t.index === originalIndex);
                      
                      return (
                        <div
                          key={`black-${idx}`}
                          className="absolute h-full bg-gradient-to-b from-gray-900 to-black hover:from-gray-800 hover:to-gray-900 active:from-gray-700 active:to-gray-800 cursor-pointer pointer-events-auto shadow-lg rounded-b transition-colors"
                          style={{
                            width: `${whiteKeyWidth * 0.6}%`,
                            left: `${whiteKeyWidth * (idx + 0.7)}%`,
                          }}
                          onTouchStart={(e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            handleKeyPress(blackNote, blackNote.freq, originalIndex);
                          }}
                          onClick={(e) => {
                            e.stopPropagation();
                            handleKeyPress(blackNote, blackNote.freq, originalIndex);
                          }}
                        >
                          {keyTaps.map(tap => (
                            <div
                              key={tap.id}
                              className={`absolute w-5 h-5 rounded-full opacity-80 pointer-events-none ${
                                tap.correct ? 'bg-green-400' : 'bg-red-400'
                              }`}
                              style={{
                                left: '50%',
                                top: '40%',
                                transform: 'translate(-50%, -50%)'
                              }}
                            />
                          ))}
                          {showLabels && (
                            <span className="absolute bottom-2 left-1/2 transform -translate-x-1/2 text-xs font-semibold text-white">
                              {blackNote.note}
                            </span>
                          )}
                        </div>
                      );
                    }
                  }
                  return null;
                })}
              </div>
            </div>
          </div>
        </div>

        <div className="mt-4 text-center text-gray-700">
          <p className="text-sm">
            üéØ Follow the sequence shown above to play the scale
          </p>
        </div>
      </div>
    </div>
  );
};

export default PianoScaleGame;
